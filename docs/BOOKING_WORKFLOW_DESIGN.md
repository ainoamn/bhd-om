# تصميم نظام سير عمل الحجوزات
## Booking Workflow System Design

---

## 1. نظرة عامة على السير

```
قيد الانتظار (PENDING)
        │
        ▼
   [التحقق من الدفع] ◄── نافذة: إدارة العقار تتحقق وتوافق على الدفع
        │
        ▼
قيد انهاء الإجراءات (CONFIRMED)
        │
        ▼
   [طلب المستندات] ◄── نافذة: تحديد المستندات المطلوبة من المستأجر
        │
        ▼
   [المستأجر يرفع المستندات] ◄── بوابة العميل أو رابط مخصص
        │
        ▼
   [اعتماد المستندات] ◄── إدارة/المؤجر يعتمد كل مستند
        │
        ▼
   [إنشاء العقد] ◄── زر يفتح صفحة إنشاء العقد
        │
        ▼
   [توقيع العقد] ◄── اعتماد من الإدارة + المستأجر + المالك
        │
        ▼
مؤجر (RENTED) ◄── العقار يتحول تلقائياً إلى مؤجر
```

---

## 2. مراحل السير التفصيلية

### المرحلة 1: قيد الانتظار (PENDING)
- **الوضع الحالي**: المستخدم يقدم طلب حجز من الموقع → يظهر في لوحة الإدارة
- **لا تغيير**: تبقى كما هي

### المرحلة 2: التحقق من الدفع والانتقال إلى قيد انهاء الإجراءات
- **الإجراء**: إدارة العقار تنقر على "نقل إلى قيد انهاء الإجراءات"
- **نافذة منبثقة** تظهر:
  1. **معلومات الدفع** (إن وُجدت):
     - طريقة الدفع (نقداً / تحويل / شيك)
     - رقم الإيصال أو الشيك
     - تاريخ الدفع
     - المبلغ
     - الحساب البنكي (للتحويل)
  2. **خيارات**:
     - "تم التحقق من الدفع واعتماده" → ينتقل إلى CONFIRMED
     - "إدخال بيانات الدفع يدوياً" (إن لم يكن المستخدم أدخلها) → حقول: طريقة الدفع، الرقم، التاريخ، المبلغ
     - "إلغاء" → يبقى PENDING
- **شرط**: يمكن الانتقال إلى CONFIRMED حتى بدون دفع (للحجوزات التي تُدفع لاحقاً) مع تنبيه

### المرحلة 3: قيد انهاء الإجراءات - طلب المستندات
- **عند الوصول إلى CONFIRMED**: تظهر نافذة أو قسم "المستندات المطلوبة"
- **قائمة المستندات القابلة للطلب** (قابلة للتخصيص):
  - بطاقة الهوية
  - صورة جواز السفر
  - إثبات العمل / راتب
  - عقد إيجار سابق
  - كشف حساب بنكي
  - مستندات أخرى (حقل حر)
- **الإجراء**: الإدارة تختار المستندات المطلوبة لهذا الحجز وتضغط "إرسال الطلب للمستأجر"
- **النتيجة**: يُنشأ رابط أو إشعار للمستأجر لرفع المستندات

### المرحلة 4: رفع المستندات من المستأجر
- **الواجهة**: 
  - بوابة عميل (إن وُجدت) أو
  - صفحة مخصصة: `/properties/[id]/bookings/[bookingId]/documents`
  - المستأجر يدخل بريده أو رقم الحجز للتحقق
- **الرفع**: لكل مستند مطلوب: زر رفع ملف (PDF, JPG, PNG)
- **الحالة**: بعد الرفع → "مرفوع - بانتظار الاعتماد"

### المرحلة 5: اعتماد المستندات
- **في لوحة الإدارة**: لكل مستند مرفوع:
  - معاينة / تحميل (الضغط على الصورة يكبرها)
  - "اعتماد" أو "رفض مع سبب" (رفض كامل أو صورة محددة)
  - ربط الواتساب والبريد: إرسال رابط الرفع للمستأجر
- **عند اعتماد جميع المستندات المطلوبة**: تُفتح صفحة اعتماد العقد تلقائياً
- **إن لم يكن المالك مرتبطاً بالعقار**: يظهر نموذج لإكمال بيانات المالك وربطه بالمبنى (مرة واحدة)

### المرحلة 6: إنشاء العقد
- **الإجراء**: عند اعتماد جميع المستندات → فتح تلقائي لصفحة إنشاء العقد
- **ربط المالك**: عند أول عقد للعقار، يُطلب ربط المالك من دفتر العناوين
- **بيانات العقد**: المالك يُستمد تلقائياً من جهة الاتصال المرتبطة

### المرحلة 7: توقيع العقد والانتقال إلى مؤجر
- **الإجراء الحالي**: اعتماد العقد من الإدارة + المستأجر + المالك → يصبح APPROVED
- **عند APPROVED**: يُحدَّث الحجز إلى RENTED والعقار إلى مؤجر تلقائياً
- **لا تغيير**: المنطق الحالي كافٍ

---

## 3. نموذج البيانات المقترح

### توسيع PropertyBooking (lib/data/bookings.ts)

```typescript
// حقول جديدة
paymentApprovedByAdmin?: boolean;      // تم اعتماد الدفع من الإدارة
paymentApprovedAt?: string;            // تاريخ اعتماد الدفع
documentsRequestedAt?: string;         // تاريخ طلب المستندات
```

### كيان جديد: BookingDocumentRequest (lib/data/bookingDocuments.ts)

```typescript
interface BookingDocumentRequest {
  id: string;
  bookingId: string;
  documentType: string;        // 'ID_CARD' | 'PASSPORT' | 'EMPLOYMENT' | 'PREVIOUS_RENT' | 'BANK_STATEMENT' | 'OTHER'
  documentLabelAr: string;
  documentLabelEn: string;
  isRequired: boolean;
  status: 'PENDING' | 'UPLOADED' | 'APPROVED' | 'REJECTED';
  fileUrl?: string;
  fileName?: string;
  uploadedAt?: string;
  approvedAt?: string;
  approvedBy?: string;
  rejectedAt?: string;
  rejectionReason?: string;
  createdAt: string;
}
```

### قائمة المستندات الافتراضية (ثوابت)

```typescript
const DEFAULT_DOCUMENT_TYPES = [
  { id: 'ID_CARD', labelAr: 'بطاقة الهوية', labelEn: 'ID Card' },
  { id: 'PASSPORT', labelAr: 'جواز السفر', labelEn: 'Passport' },
  { id: 'EMPLOYMENT', labelAr: 'إثبات العمل / راتب', labelEn: 'Employment / Salary proof' },
  { id: 'PREVIOUS_RENT', labelAr: 'عقد إيجار سابق', labelEn: 'Previous rent contract' },
  { id: 'BANK_STATEMENT', labelAr: 'كشف حساب بنكي', labelEn: 'Bank statement' },
  { id: 'OTHER', labelAr: 'مستند آخر', labelEn: 'Other document' },
];
```

---

## 4. الملفات والمكونات المطلوبة

| الملف / المكون | الوظيفة |
|----------------|---------|
| `lib/data/bookingDocuments.ts` | إدارة طلبات المستندات والمستندات المرفوعة |
| `lib/data/bookings.ts` | إضافة `paymentApprovedByAdmin` ووظائف التحقق |
| `components/admin/BookingPaymentVerifyModal.tsx` | نافذة التحقق من الدفع والانتقال لـ CONFIRMED |
| `components/admin/BookingDocumentsPanel.tsx` | لوحة المستندات المطلوبة + الاعتماد + واتساب/بريد |
| `lib/data/bookingDocuments.ts` | إدارة المستندات (رفع، استبدال، رفض مع أرشفة) |
| `lib/data/propertyLandlords.ts` | ربط المالك بالعقار |
| `lib/documentUploadLink.ts` | رابط الرفع وإرسال واتساب/بريد |
| `app/[locale]/properties/[id]/contract-terms/page.tsx` | صفحة شروط العقد ورفع المستندات للمستأجر |
| `app/[locale]/properties/[id]/upload-documents/page.tsx` | صفحة رفع المستندات (بوابة بديلة) |

---

## 5. واجهة المستخدم (UI) المقترحة

### في صفحة الحجوزات (properties/[id]/bookings)

#### للحجز PENDING:
- زر **"نقل إلى قيد انهاء الإجراءات"** بدلاً من القائمة المنسدلة المباشرة
- عند النقر → فتح **نافذة التحقق من الدفع**
  - عرض بيانات الدفع (إن وُجدت)
  - زر "اعتماد الدفع والانتقال"
  - أو "إدخال بيانات الدفع يدوياً" ثم الاعتماد

#### للحجز CONFIRMED:
- قسم **"المستندات المطلوبة"**:
  - قائمة المستندات مع حالة كل واحد (مطلوب / مرفوع / معتمد / مرفوض)
  - زر "إضافة مستند مطلوب"
  - زر "إرسال رابط الرفع للمستأجر" (ينسخ رابط أو يرسل بريد)
  - لكل مستند مرفوع: معاينة، اعتماد، رفض
- زر **"إنشاء عقد"** يظهر عندما تكون كل المستندات المطلوبة معتمدة

---

## 6. تسلسل التنفيذ المقترح

1. **المرحلة أ**: إنشاء `lib/data/bookingDocuments.ts` + توسيع `bookings.ts`
2. **المرحلة ب**: مكون `BookingPaymentVerifyModal` + ربطه بصفحة الحجوزات
3. **المرحلة ج**: مكون `BookingDocumentsPanel` + واجهة طلب واعتماد المستندات
4. **المرحلة د**: صفحة رفع المستندات للمستأجر (رابط عام أو بوابة)
5. **المرحلة هـ**: تحسينات (إشعارات، نسخ رابط، إلخ)

---

## 7. ملاحظات أمنية

- التحقق من هوية المستأجر عند رفع المستندات (بريد، رمز، أو رقم حجز)
- تخزين الملفات في مجلد آمن (مثل `public/uploads/booking-docs/`) مع أسماء عشوائية
- عدم عرض روابط الملفات إلا للمستخدمين المصرح لهم

---

*تم إعداد هذا التصميم بتاريخ 2025-02*
