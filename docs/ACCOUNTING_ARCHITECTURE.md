# Global Intelligent Accounting & ERP Platform
# المعمارية والمواصفات - Architecture & Specifications

## 1. القواعد الحاكمة (EXECUTION RULES)

| القاعدة | التطبيق |
|---------|----------|
| **لا عملية بدون قيد محاسبي** | كل معاملة مالية تُولد قيداً تلقائياً عبر Posting Rules |
| **لا قيد بدون مستند** | القيود اليدوية مسموحة؛ قيود الفواتير/الإيصالات مرتبطة بمستند |
| **لا تعديل بدون أثر تدقيقي** | Audit Log يسجل كل تغيير مع السبب والمستخدم |
| **لا حذف نهائي** | إلغاء (CANCEL) أو عكس (REVERSE) فقط - لا DELETE |
| **لا ترحيل لفترة مغلقة** | Period Lock يمنع الترحيل على الفترات المغلقة |
| **لا منطق محاسبي في الواجهة** | كل المنطق في Accounting Engine و Posting Rules |
| **لا قرار مالي بدون بيانات** | AI اقتراحي فقط - لا ينفذ قرارات مالية |

## 2. الطبقات المعمارية (ARCHITECTURE LAYERS)

```
┌─────────────────────────────────────────────────────────────┐
│  Presentation Layer (React/Next.js)                          │
│  - AccountingSection.tsx | InvoicePrint.tsx                  │
│  - عرض فقط - لا منطق محاسبي                                  │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│  Application Services (lib/data/accounting.ts)              │
│  - واجهة موحدة للمكونات                                      │
│  - توجيه الطلبات للـ Engine                                  │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│  Accounting Engine (lib/accounting/engine/)                   │
│  - journalEngine.ts: قيد مزدوج | توازن | دقة                  │
│  - لا تعديل بدون تحقق                                        │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│  Posting Rules Engine (lib/accounting/rules/)                 │
│  - تحويل المستندات إلى قيود تلقائياً                         │
│  - سياسات الضرائب | التحصيل | التسويات                        │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│  Audit & Compliance Engine (lib/accounting/audit/)            │
│  - سجل تدقيق غير قابل للتعديل                                │
│  - سلسلة الأدلة | تاريخ التغييرات                             │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│  AI & Analytics Engine (lib/accounting/ai/)                   │
│  - نسب مالية | تحليل التقادم | كشف الشذوذ                     │
│  - اقتراحي فقط - لا قرارات مباشرة                             │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│  Data Layer (lib/accounting/data/storage.ts)                  │
│  - localStorage (حالياً) | Prisma/DB (مستقبلاً)              │
└─────────────────────────────────────────────────────────────┘
```

## 3. المعايير المحاسبية (ACCOUNTING STANDARDS)

- **IFRS**: إطار معايير التقارير المالية الدولية
- **Accrual Accounting**: أساس الاستحقاق
- **Double Entry**: قيد مزدوج - المدين = الدائن
- **Period Locking**: إغلاق الفترات المالية
- **Precision**: دقتان عشريتان (0.01)
- **Balance Tolerance**: ±0.01 للتقريب

## 4. النواة المحاسبية (ACCOUNTING CORE)

### Chart of Accounts
- هرمي (parentId)
- 5 أنواع: ASSET, LIABILITY, EQUITY, REVENUE, EXPENSE
- رمز فريد (code)

### Journal Engine
- Balance Check على مستوى كل قيد
- Precision Control
- Period Lock Enforcement
- Referential Integrity (accountId موجود)

### Ledger
- غير قابل للتعديل (Immutable)
- القيود الملغاة: status=CANCELLED أو replacedBy
- لا حذف - عكس أو إلغاء فقط

### Period Management
- فترات مالية (FiscalPeriod)
- قفل الفترة يمنع الترحيل
- إغلاق مع تسجيل المستخدم والتاريخ

## 5. سجل التدقيق (AUDIT TRAIL)

كل إجراء:
- **موقّت**: timestamp
- **مرتبط بمستخدم**: userId
- **مرتبط بسبب**: reason (للتعديل/الإلغاء)
- **قابل للتتبع**: entityType, entityId, previousState, newState

## 6. الذكاء الاصطناعي (AI - اقتراحي فقط)

- اقتراح الحساب من الوصف
- كشف الشذوذ (رصيد سالب، تكرار مشبوه)
- نسب مالية (نسبة التداول، إلخ)
- تحليل التقادم (Aging)
- تنبيهات المخاطر

**لا ينفذ قرارات مالية مباشرة.**

## 7. التخزين الحالي (Storage)

| المفتاح | المحتوى |
|---------|---------|
| bhd_chart_of_accounts | دليل الحسابات |
| bhd_journal_entries | قيود اليومية |
| bhd_accounting_documents | الفواتير والإيصالات |
| bhd_fiscal_settings | إعدادات السنة المالية |
| bhd_fiscal_periods | الفترات المالية |
| bhd_audit_log | سجل التدقيق |

## 8. التكامل المستقبلي

- Prisma schema جاهز للترحيل إلى SQLite/PostgreSQL
- REST APIs
- Webhooks
- E-Invoicing
- Payment Gateways
