# دليل التدقيق
# Audit Guide

## 1. سجل التدقيق (Audit Trail)

- **غير قابل للتعديل (Immutable)**: لا يُحذف ولا يُعدّل أي سجل تدقيق.
- **كل إجراء**: موقّت | مرتبط بمستخدم | مرتبط بسبب | قابل للتتبع.

## 2. الأحداث المسجلة (Logged Events)

| الحدث | الوصف |
|-------|-------|
| CREATE | إنشاء قيد أو مستند |
| UPDATE | تعديل قيد أو مستند |
| CANCEL | إلغاء |
| REVERSE | عكس قيد |
| PERIOD_LOCK | إغلاق فترة مالية |

## 3. سلسلة الأدلة (Evidence Chain)

- **entityType**: ACCOUNT | JOURNAL_ENTRY | DOCUMENT | PERIOD
- **entityId**: معرف الكيان
- **previousState**: الحالة قبل التعديل (JSON)
- **newState**: الحالة بعد التعديل (JSON)
- **reason**: سبب التعديل (للتعديل/الإلغاء)

## 4. كيفية مراجعة سجل التدقيق

1. **عبر الواجهة**: تبويب "التدقيق" في صفحة المحاسبة.
2. **عبر API**: `GET /api/accounting/audit?entityType=JOURNAL_ENTRY&entityId=xxx`
3. **التصفية**: حسب entityType، entityId، التاريخ.

## 5. فحص القيود (Journal Entry Review)

- التحقق من **توازن القيد**: المدين = الدائن.
- التحقق من **ربط المستند**: documentId موجود للفواتير/الإيصالات.
- التحقق من **الفترة**: لا ترحيل لفترة مغلقة.

## 6. فحص الشذوذ (Anomaly Detection)

- **رصيد أصول سالب**: غير متوقع - تحقق من القيود.
- **رصيد التزامات سالب**: مراجعة الترحيل.
- **تنبيهات الذكاء الاصطناعي**: عرض في لوحة التحكم.

## 7. الصلاحيات (RBAC)

| الدور | الصلاحيات |
|-------|-----------|
| ACCOUNTANT | عرض، إنشاء قيود، إنشاء مستندات، تقارير |
| APPROVER | + اعتماد، إلغاء |
| AUDITOR | عرض، تقارير، سجل التدقيق |
| ADMIN | كل الصلاحيات + إغلاق الفترات |

## 8. التوافق (Compliance)

- **COSO Framework**: فصل الصلاحيات، رقابة مستمرة.
- **Audit Trail**: سجل غير قابل للتعديل.
- **Risk Flags**: تنبيهات في لوحة التحكم.
